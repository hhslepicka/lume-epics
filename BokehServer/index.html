<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://slaclab.github.io/lume-epics/BokehServer/" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>Bokeh Server - lume-epics</title>
<link href="../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="..">lume-epics</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="..">Overview</a>
</li>
<li class="navitem">
<a class="nav-link" href="../Install/">Install</a>
</li>
<li class="dropdown active">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Tutorial <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item active" href="./">Bokeh Server</a>
</li>
<li>
<a class="dropdown-item" href="../Jupyter/">Jupyter Notebook Demo</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Documentation <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../Layout/">Layout</a>
</li>
<li class="dropdown-submenu">
<a class="dropdown-item" href="#">Client</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../Controller/">Controller</a>
</li>
<li>
<a class="dropdown-item" href="../Monitors/">Monitors</a>
</li>
<li>
<a class="dropdown-item" href="../Widgets/">Widgets</a>
</li>
</ul>
</li>
<li>
<a class="dropdown-item" href="../Model/">Model</a>
</li>
<li>
<a class="dropdown-item" href="../Server/">Server</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="../Install/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../Jupyter/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="https://github.com/slaclab/lume-epics/edit/master/docs/BokehServer.md"><i class="fa fa-github"></i> Edit on GitHub</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#bokeh-serve-client-tutorial">Bokeh-serve client tutorial</a>
<ul class="nav flex-column">
<li class="nav-item" data-level="2"><a class="nav-link" href="#set-up-conda-environment">Set up conda environment</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#create-model">Create model</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#create-server">Create server</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#set-up-the-client">Set up the client</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
<li class="nav-item" data-level="1"><a class="nav-link" href="#run-demo">Run demo</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="bokeh-serve-client-tutorial">Bokeh-serve client tutorial</h1>
<p>For this tutorial, we will create a simple model which generates an image from sampled from a uniform distribution between the two scalar input variables. This model will be served using the lume-epics server and a bokeh client will be used to display simple sliders for controlling the image, and the image output. </p>
<h3 id="note">Note:</h3>
<p>The code for this example can be found in <a href="https://github.com/slaclab/lume-epics/examples">lume-epics/examples</a></p>
<h2 id="set-up-conda-environment">Set up conda environment</h2>
<p><code>$ conda create -n lume-epics-demo python=3.7</code></p>
<p><code>$ conda activate lume-epics-demo</code></p>
<p><code>$ conda install numpy</code></p>
<p>Install lume-model and lume-epics from the <code>jrgarrahan</code> conda channel:</p>
<p><code>$ conda install lume-model lume-epics -c jrgarrahan</code></p>
<h2 id="create-model">Create model</h2>
<p>Create a new file named <code>model.py</code>. At the top of the file, import the <code>lume-model</code> <code>SurrogateModel</code> base class, <code>lume-model</code> <code>ScalarInputVariable</code> and <code>ImageOutputVariable</code>, <code>numpy</code>, and the <code>lume-model</code> <code>save_variables</code> utility.</p>
<pre><code class="python">import numpy as np
from lume_model.variables import ScalarInputVariable, ImageOutputVariable
from lume_model.models import SurrogateModel
from lume_model.utils import save_variables
</code></pre>
<p>Next, define the demo model. Here, we define the input and output variables as keyword arguments. In order for the evaluate method to execute correctly, these 
passed variables must be dictionaries of variables with corresponding types and names. These could also be defined as class attributes.</p>
<pre><code class="python">class DemoModel(SurrogateModel):
    def __init__(self, input_variables=None, output_variables=None):
        self.input_variables = input_variables
        self.output_variables = output_variables

    def evaluate(self, input_variables):
        self.output_variables["output1"].value = np.random.uniform(
            self.input_variables["input1"].value, # lower dist bound
            self.input_variables["input2"].value, # upper dist bound
            (50,50)
        )

        return list(self.output_variables.values())
</code></pre>
<p>Now, we use the main method to define and save the input and output variables. This is done in the main method because the server will import and execute the <code>DemoModel</code> class. </p>
<pre><code class="python">if __name__ == "__main__":
    input_variables = {
        "input1": ScalarInputVariable(
            name="input1", 
            value=1, 
            default=1, 
            range=[0, 256]
        ),
        "input2": ScalarInputVariable(
            name="input2", 
            value=2, 
            default=2, 
            range=[0, 256]),
    }

    output_variables = {
        "output1": ImageOutputVariable(
            name="output1", 
            axis_labels=["value_1", "value_2"], 
            axis_units=["mm", "mm"], 
            x_min=0, 
            x_max=50, 
            y_min=0, 
            y_max=50
        )
    }

    variable_filename = "variables.pickle"

    save_variables(
        input_variables, 
        output_variables, 
        variable_filename
    )
</code></pre>
<h2 id="create-server">Create server</h2>
<p>Create a new file named <code>server.py</code>. Import the <code>DemoModel</code>, load the variables, and configure the server. </p>
<pre><code class="python">from examples.model import DemoModel
from lume_epics.epics_server import Server
from lume_model.utils import load_variables

variable_filename = "variables.pickle"
input_variables, output_variables = load_variables(variable_filename)

# pass the input + output variable to initialize the classs
model_kwargs = {
    "input_variables": input_variables,
    "output_variables": output_variables
}

prefix = "test"
server = Server(
    DemoModel, 
    input_variables, 
    output_variables, 
    prefix,
    model_kwargs=model_kwargs
)
# monitor = False does not loop in main thread
server.start(monitor=True)
</code></pre>
<h2 id="set-up-the-client">Set up the client</h2>
<p>Create a new file named <code>client.py</code>. Add the following imports:</p>
<pre><code class="python">from bokeh.io import curdoc
from bokeh import palettes
from bokeh.layouts import column, row
from bokeh.models import LinearColorMapper

from lume_epics.client.controller import Controller
from lume_model.utils import load_variables

from lume_epics.client.widgets.plots import ImagePlot
from lume_epics.client.widgets.controls import build_sliders
from lume_epics.client.controller import Controller
</code></pre>
<p>Set up the <code>Controller</code> for interfacing with EPICS process variables:</p>
<pre><code class="python">controller = Controller("ca")
</code></pre>
<p>Load variables from your variable file:</p>
<pre><code class="python">input_variables, output_variables = load_variables("variables.pickle")
</code></pre>
<p>Prepare sliders:</p>
<pre><code class="python">prefix = "test"

# use all input variables for slider
# prepare as list for rendering
input_variables = list(input_variables.values())

# build sliders
sliders = build_sliders(input_variables, controller, prefix)
</code></pre>
<p>Setup the image output variable:</p>
<pre><code class="python">output_variables = list(output_variables.values())

# create image plot
image_plot = ImagePlot(output_variables, controller, prefix)

# build plot using a bokeh color map
pal = palettes.viridis(256)
color_mapper = LinearColorMapper(palette=pal, low=0, high=256)

image_plot.build_plot(color_mapper=color_mapper)
</code></pre>
<p>The image plot will require a callback to continually update the plot to display the lates process variables. Here we define the callback function:</p>
<pre><code class="python"># Set up image update callback
def image_update_callback():
    image_plot.update()

</code></pre>
<p>Render the application using bokeh <code>curdoc()</code> function. The image_plot object's <code>plot</code> attribute must be used in formatting:</p>
<pre><code class="python">curdoc().title = "Demo App"
curdoc().add_root(
            row(
                column(sliders, width=350), column(image_plot.plot)
                ) 
    )

curdoc().add_periodic_callback(image_update_callback, 250)
</code></pre>
<h1 id="run-demo">Run demo</h1>
<p>Now, open two terminal windows and navigate to the directory with your demo files. Activate the <code>lume-epics-demo</code> environment. In the first, execute the command:</p>
<p><code>$ python example/server.py</code></p>
<p>In the second, serve the bokeh client using the command:</p>
<p><code>$ bokeh serve --show example/client.py</code></p>
<p>A browser window will display the user interface. Both the client and server may be terminated with keyboard interrupt (<code>Ctrl+C</code>).</p></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../js/base.js"></script>
<div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
